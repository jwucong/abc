!function(window,document,JSON,$){if(!isWeiXin()||is($,"Undefined"))return!1;function isWeiXin(){var ua=window.navigator.userAgent.toLowerCase();return/micromessenger/.test(ua)}function isIOS(){var iosReg=/\(i[^;]+;( U;)? CPU.+Mac OS X/i,ua=navigator.userAgent;return iosReg.test(ua)}function is(value,type){return{}.toString.call(value).replace(/^\[object\s(\w+)\]$/,"$1")===type}function isFreeGou(){return $(".yi-yuan-gou").hasClass("freeGou")}function getUrlQuery(key){var queryStr,queryArr=window.location.search.substr(1).split("&"),query={};return queryArr.forEach(function(item){var kv=item.split("="),k=kv[0],v=kv[1];k&&(query[k]=void 0===v?void 0:decodeURIComponent(v))}),key?query[key]:query}function redirect(query){if(query&&!invalidAct&&!unstartAct){var params=$.extend({},getUrlQuery(),query),search=[];for(var key in params)if(params.hasOwnProperty(key)){var param=key+"="+encodeURIComponent(params[key]);search.push(param)}var currentUrl=window.location.href,endIndex=currentUrl.indexOf("?"),path,targetUrl=(-1===endIndex?currentUrl:currentUrl.slice(0,endIndex))+"?"+search.join("&");currentUrl!==targetUrl&&(window.location.href=targetUrl)}}function getUrlQueryByResponse(res){var data=res.data;return data?{joinId:data.id,joinCardOpenId:data.cardOpenId,activityId:data.activityId,queryDate:window.utils.formatDate(Date.now(),"yyyy-MM-dd")}:{}}function secondToHms(s){if(s<=0)return"00天00时00分00秒";var f=function(v){return v<10?"0"+v:v},dd,hh,mm,ss,array;return[f(Math.floor(s/3600/24)),"天",f(Math.floor(s/3600)%24),"时",f(Math.floor(s/60)%60),"分",f(Math.floor(s%60)),"秒"].join("")}var WX_SDK=window._um_weixin_sdk,JOIN_DATA={minimumMember:MIN_HELP_PERSON_NUMBER,goodsNumber:PRODUCT_NUMBER,purchasePrice:ORIGINAL_PRICE},PAY_AMOUNT=1,ICON_JOIN_SUCCESS="http://i0.um.tcl.com/icon-wepage-ok.png",ICON_SUBMIT_SUCCESS="http://i0.um.tcl.com/icon-wepage-ok2.png",ICON_ACTIVITE_END="http://i0.um.tcl.com/icon-wepage-time.png",ICON_NO_GOODS="http://i0.um.tcl.com/icon-wepage-none.png",ICON_AUTHORIZE="http://i0.um.tcl.com/icon-wepage-default-avatar.png",DEFAULT_AVATAR="http://i0.um.tcl.com/icon-wepage-no-avatar.png",NO_MOREUSER="http://i0.um.tcl.com/icon-wepage-wenhao.png",FOLLOW_QRCODE="http://i0.um.tcl.com/icon-wepage-ok.png",paying=!1,joining=!1,activiteStep=1,helperHasJoin=!1,urlQuery=null,invalidAct=!1,unstartAct=!1,curTime="";$(function(){var body=$(document.body),wrap=$(".yi-yuan-gou"),countDoneNode=wrap.find(".count-down"),progreesCurrent=wrap.find(".progrees .current"),progreesDot=wrap.find(".progrees .dot"),avatarNode=wrap.find(".avatar img"),productNumNode=wrap.find(".price .others .num"),helperCountNode=wrap.find(".product .person"),remainHelperCountNode=wrap.find(".product .J_remainedPerson"),moneyCountNode=wrap.find(".product .money"),reamainMoneyCountNode=wrap.find(".product .J_remainedMoney"),reamainProductNode=wrap.find(".product .remain-product"),joinedPerson=wrap.find(".product .joined-person span"),days=wrap.find(".days"),popup=wrap.find(".popup"),popupMask=popup.find(".mask"),loading=popup.find(".loading"),popupContent=popup.find(".content"),popupShare=popup.find(".share"),popupIcon=popup.find(".icon img"),popupTitle=popup.find("h3"),popupSubTitle=popup.find("p"),popupClose=popup.find(".close"),getVerifyBtn=popup.find(".getvalidate-tbn"),submitBtn=wrap.find(".submit"),payFormItems=popup.find(".input-box");function initPage(){WX_SDK.onPaySuccess=function(){getActiviteDetails()},popupClose.add(popupMask).add(popupShare).on("click",closePopup),getVerifyBtn.on("click",getVerifyCode),isFreeGou()?getPeriodTime(1e3*WX_SDK.getActivityStartTime(),1e3*WX_SDK.getActivityEndTime()):activiteCountDown(WX_SDK.getActivityEndTime()),addVerifiers(),getActiviteDetails(),isHelper()&&(help(),updateHelperSubmitBtn()),isActivityEnd()&&alertActiviteEnd(),isWeiXin()&&isIOS()&&fixPullDownBug()}function fixPullDownBug(){var scrollTop=0,timerId;document.body.addEventListener("focusin",()=>{scrollTop=document.documentElement.scrollTop||window.pageYOffset||document.body.scrollTop,clearTimeout(timerId)},!1),document.body.addEventListener("focusout",()=>{clearTimeout(timerId),timerId=setTimeout(function(){window.scrollTo({top:scrollTop,behavior:"smooth"})},300)},!1)}function isHelper(){var query=getUrlQuery(),count=0,params=["joinId","joinCardOpenId","activityId"];for(var key in query)query.hasOwnProperty(key)&&params.indexOf(key)>-1&&count++;return!(count<params.length)&&query.joinCardOpenId!==WX_SDK.getCardOpenid()}function disabledScroll(event){event.preventDefault()}function showPopup(){body.addClass("disabled-scroll"),popup.on("touchmove",disabledScroll),popup.show()}function closePopup(){body.removeClass("disabled-scroll"),popup.off("touchmove",disabledScroll),popup.hide(),popupShare.hide(),clearPayForm(),wrap.find(".payment .wechat-pay").remove(),urlQuery&&(redirect(urlQuery),urlQuery=null)}function showMoreHelpers(data){for(var avatarList="",assistantAvatarList="",i=0;i<5;i++){var aheadImgUrl,aNickname;assistantAvatarList+=`<div class="avatar-item"><img src="${void 0===data[i]?NO_MOREUSER:data[i].headImgUrl}"><span>${void 0===data[i]?"":data[i].nickname}</span></div>`}var disableClass=data.length<5?"disabled":"";wrap.find(".more-avatar").html(assistantAvatarList).append(`<div class="avatar-item J_showMore ${disableClass}"><img src="http://i0.um.tcl.com/icon-wepage-gengduo.png"></div>`),data.map(function(item,index){avatarList+=`<div class="avatar-item"><img src="${item.headImgUrl}" /><span>${item.nickname}</span></div>`}),popup.find(".avatar-box").html(avatarList),wrap.find(".J_showMore").on("click",function(){closePopup(),loading.hide(),popup.find(".tips").hide(),popup.find(".payment").hide(),$(this).hasClass("disabled")||(wrap.find(".more-helpers").show(),popupContent.show(),popup.show())})}function joinActivite(){function successHandle(res){joining=!1,submitBtn.removeClass("disabled"),closePopup(),1===res.code?(alertJoinSuccess(),urlQuery=getUrlQueryByResponse(res)):alert(res.msgZ)}function errorHandle(err){joining=!1,submitBtn.removeClass("disabled")}joining||(joining=!0,submitBtn.addClass("disabled"),WX_SDK.joinActivity(JOIN_DATA,successHandle,errorHandle))}function help(){var data=getUrlQuery();function helpSuccessHandle(res){1==res.code?(getActiviteDetails(),!helperHasJoin&&updateSubmitBtn({text:"助力成功，我也要参与",handler:joinActivite},res)):alert(res.msgZ)}function helpErrorHandle(err){}WX_SDK.assistanceActivity(data,helpSuccessHandle,helpErrorHandle)}function updateHelperSubmitBtn(){var data={joinId:0,activityId:WX_SDK.getActivityIds(),joinCardOpenId:WX_SDK.getCardOpenid(),queryDate:window.utils.formatDate(curTime,"yyyy-MM-dd")},successHandle=function(res){var joinStatus;res.data.joinStatus>1?(helperHasJoin=!0,updateSubmitBtn({text:"查看我的参与",handler:function(){redirect(getUrlQueryByResponse(res))}})):updateSubmitBtn({text:"助力成功，我也要参与",handler:joinActivite},res),updateWtarmarkStatus()},errorHandle=function(){updateWtarmarkStatus()};WX_SDK.getJoinActivity(data,successHandle,errorHandle)}function getActiviteDetails(){alertLoading();var query=getUrlQuery(),data={joinId:query.joinId||0,activityId:query.activityId||WX_SDK.getActivityIds(),joinCardOpenId:query.joinCardOpenId||WX_SDK.getCardOpenid(),queryDate:window.utils.formatDate(curTime,"yyyy-MM-dd")};function successHandle(res){var data=res.data;(activiteStep=data.joinStatus)>1&&redirect(getUrlQueryByResponse(res)),renderPage(data),isHelper()?updateHelperSubmitBtn():updateSubmitBtn(activiteStep,res),updateWtarmarkStatus(),closePopup()}function errorHandle(err){}WX_SDK.getJoinActivity(data,successHandle,errorHandle)}function updateWtarmarkStatus(){invalidAct?(submitBtn.off("click").text("活动已失效").addClass("disabled"),invalidWatermark.show(),unstartWatermark.hide()):unstartAct?(submitBtn.off("click").text("活动未开始").addClass("disabled"),unstartWatermark.show(),invalidWatermark.hide()):(invalidWatermark.hide(),unstartWatermark.hide())}function renderPage(data){var moneyCount=data.accumulativeMoney||0,goodsNum=null===data.countSurplus?PRODUCT_NUMBER:data.countSurplus,assistanceHeadImgList=null===data.assistanceHeadImgList?[]:data.assistanceHeadImgList;if(activiteStep=data.joinStatus||1,productNumNode.text("数量: "+goodsNum),helperCountNode.text(data.accumulativeMember||0),moneyCountNode.text(moneyCount),avatarNode.attr("src",data.headImgUrl||DEFAULT_AVATAR),showMoreHelpers(assistanceHeadImgList),isFreeGou()){var remainHelper=null===data.progressData?0:data.progressData.surplusAssistanceNumber,remainMoneyCount=null===data.progressData?0:data.progressData.surplusAssistanceMoney,joinedPersonNum=null===data.progressData?0:data.progressData.totalJoinNumber,remainProductNum=null===data.progressData?0:data.progressData.surplusGoodsNumber;remainHelperCountNode.text(remainHelper),reamainMoneyCountNode.text(remainMoneyCount),joinedPerson.text(joinedPersonNum),reamainProductNode.text(remainProductNum),setProgress(100*(PRODUCT_NUMBER-remainProductNum))}else setProgress(moneyCount/(ORIGINAL_PRICE-1)*100)}function getPeriodTime(start,end){for(var daysLength=Math.round((end-start)/864e5)+1,daysList="",curMonth=(new Date).getMonth()+1,curDay=(new Date).getDate(),i=0;i<daysLength;i++){var iDate=start+24*i*60*60*1e3,iMonth=Math.round(new Date(iDate).getMonth())+1,iDay=Math.round(new Date(iDate).getDate());iMonth>curMonth?daysList+=`<div class="day-item J_invalid" data-date="${iDate}">${iMonth}月${iDay}日 <br /><span>已失效</span> </div>`:iMonth===curMonth?daysList+=iDay>curDay?`<div class="day-item J_unstart" data-date="${iDate}">${iMonth}月${iDay}日 <br /><span>00:00开启</span> </div>`:iDay===curDay?`<div class="day-item cur-day" data-date="${iDate}">${iMonth}月${iDay}日 <br /><span>正在抢购</span> </div>`:`<div class="day-item J_invalid" data-date="${iDate}">${iMonth}月${iDay}日 <br /><span>已失效</span> </div>`:iMonth<curMonth&&(daysList+=`<div class="day-item J_unstart" data-date="${iDate}">${iMonth}月${iDay}日 <br /><span>00:00开启</span> </div>`)}days.html(daysList);var curDayOLeft=days.find(".cur-day");curDayOLeft.offset().left&&days.scrollLeft(curDayOLeft.offset().left-10),days.find(".day-item").on("click",function(){$(this).addClass("cur-day").siblings(".day-item").removeClass("cur-day"),$(this).hasClass("J_unstart")?(invalidAct=!1,unstartAct=!0):$(this).hasClass("J_invalid")?(unstartAct=!1,invalidAct=!0,activiteStep<3&&wrap.find(".fail-tips").show()):(unstartAct=!1,invalidAct=!1,wrap.find(".fail-tips").hide()),curTime=$(this).data("date"),getActiviteDetails()})}function setProgress(value){value<=0&&(value=0),value>=100&&(value=100);var percent=value+"%";progreesCurrent.width(percent),progreesDot.css("left",percent)}function updateSubmitBtn(value,response){var rd=is(response,"Object")&&response.data||{},goodsNum=is(rd.countSurplus,"Null")?PRODUCT_NUMBER:rd.countSurplus,isNoGoods=PRODUCT_NUMBER<=0||goodsNum<=0,text="我要参与",handler=null;is(value,"Object")?(text=value.text,handler=value.handler):1==value?(text=isFreeGou()?"立即参与":"我要参与",handler=joinActivite):2==value?(text="邀请好友助力",handler=alertShare):3==value&&(text=isFreeGou()?"提交表单":"1元购买",handler=checkWechatPay),isNoGoods&&(handler=alertNoGoods),isActivityEnd()&&(handler=alertActiviteEnd),4!=value&&5!=value||(text=isFreeGou()?"参与成功":"已购买",handler=null),submitBtn.text(text).removeClass("disabled"),submitBtn.off("click"),is(handler,"Function")&&submitBtn.on("click",handler)}function addVerifiers(){payFormItems.each(function(index,item){var that=$(item),input=that.find("input"),verifiers=[validatePayFormName,validatePayFormTel,validatePayFormVerifyCode];input.on("focus",function(){that.removeClass("check-fail")}),input.on("blur",function(){verifiers[index](that)})})}function alertJoinSuccess(){closePopup();var title=isFreeGou()?"":"恭喜您，参与成功",subTitle=isFreeGou()?"参与成功，请邀请好友为您助力，<br />获得0元秒杀机会":"邀请好友为您助力，1元抢购商品";setPopupContent(ICON_JOIN_SUCCESS,title,subTitle),loading.hide(),popupContent.find(".authorize").hide(),popupContent.find(".more-helpers").hide(),popupContent.find(".general").show(),popupContent.find(".tips").show(),popupContent.find(".payment").hide(),popupContent.show(),showPopup()}function alertShare(){closePopup(),loading.hide(),popupContent.hide(),popupShare.show(),showPopup()}function alertLoading(){closePopup(),popupContent.hide(),loading.show(),showPopup()}function alertActiviteEnd(){closePopup(),setPopupContent(ICON_ACTIVITE_END,"亲，活动已经结束哦","持续关注TCL，可参与更多活动"),popupIcon.attr("src",ICON_ACTIVITE_END),loading.hide(),popupContent.find(".authorize").hide(),popupContent.find(".more-helpers").hide(),popupContent.find(".general").show(),popupContent.find(".tips").show(),popupContent.find(".payment").hide(),popupContent.show(),showPopup()}function alertNoGoods(){closePopup();var subTitle=isFreeGou()?"您可以在次日0点持续参与活动":"持续关注TCL，可参与更多活动";setPopupContent(ICON_NO_GOODS,"十分遗憾，商品已抢完",subTitle),popupIcon.attr("src",ICON_NO_GOODS),loading.hide(),popupContent.find(".authorize").hide(),popupContent.find(".more-helpers").hide(),popupContent.find(".general").show(),popupContent.find(".tips").show(),popupContent.find(".payment").hide(),popupContent.show(),showPopup()}function alertPay(){closePopup();var payBtn=isFreeGou()?$('<div class="wechat-pay">提交</div>'):$('<div class="wechat-pay">微信支付</div>');payBtn.off("click").on("click",handleWechatPay),wrap.find(".payment").append(payBtn),loading.hide(),popupShare.hide(),popupContent.find(".tips").hide(),popupContent.find(".more-helpers").hide(),popupContent.find(".payment").show(),popupContent.show(),showPopup()}function alertSubmitSuccess(){closePopup(),setPopupContent(ICON_SUBMIT_SUCCESS,"","提交成功，内容卡的账号密码将通过<br />短信方式发送到您的手机"),popupIcon.attr("src",ICON_SUBMIT_SUCCESS),loading.hide(),popupContent.find(".authorize").hide(),popupContent.find(".more-helpers").hide(),popupContent.find(".general").show(),popupContent.find(".tips").show(),popupContent.find(".payment").hide(),popupContent.show(),showPopup()}function alertScanQRcodeFollow(){closePopup(),setPopupContent(FOLLOW_QRCODE,"关注公众号","暂缺二维码，待更新"),loading.hide(),popupContent.find(".authorize").hide(),popupContent.find(".more-helpers").hide(),popupContent.find(".general").show(),popupContent.find(".tips").show(),popupContent.find(".payment").hide(),popupContent.show(),showPopup()}function setPopupContent(iconSrc,title,subTitle){popupIcon.attr("src",iconSrc),popupTitle.text(title),popupSubTitle.html(subTitle)}function clearPayForm(){payFormItems.each(function(index,item){$(item).removeClass("check-fail").find("input").val("")})}function isActivityEnd(){var endTime=WX_SDK.getActivityEndTime(),nowTime;return Math.floor((new Date).getTime()/1e3)>=endTime}function checkWechatPay(){if(isActivityEnd())alertActiviteEnd();else{var data=getUrlQuery(),successHandler=function(res){var rd=res.data||{},remainGoodsNum=isFreeGou()?rd.progressData.surplusGoodsNumber:rd.countSurplus;1==res.code?remainGoodsNum>0?alertPay():alertNoGoods():alert(res.msgZ)},errorHandler=function(){};WX_SDK.getJoinActivity(data,successHandler,errorHandler)}}function handleWechatPay(){var payBtn=wrap.find(".payment .wechat-pay"),disabled;if(!(paying||payBtn.hasClass("disabled")||!validatePayForm())){paying=!0,payBtn.addClass("disabled");var validateUrl=isFreeGou()?$("#formSubmitUrl").val():$("#paySubmitUrl").val(),name,tel,vcode,data={pageId:null,formId:10,data:[{name:"姓名",type:"text",value:getFormValue(payFormItems.eq(0))},{name:"手机号码",type:"text",tip:"tel",value:getFormValue(payFormItems.eq(1))},{name:"手机验证码",type:"text",tip:"vCode",value:getFormValue(payFormItems.eq(2))}]},successHandler=function(res){if(1==res.code)if(isFreeGou())getActiviteDetails(),alertSubmitSuccess();else{var money=100*PAY_AMOUNT,cardTitle="一元抢好物",channel=WX_SDK.getChannel(),mobile=getFormValue(payFormItems.eq(1));WX_SDK.pay(money,"一元抢好物",channel,mobile)}else alert(res.msgZ)},errorHandler=function(err){},completeHandler=function(){paying=!1,payBtn.removeClass("disabled"),isFreeGou()||(closePopup(),getActiviteDetails())};$.ajax({url:validateUrl,type:"POST",data:JSON.stringify(data),contentType:"application/json",dataType:"json",cache:!1,success:successHandler,error:errorHandler,complete:completeHandler})}}function getFormValue($node){return $node.find("input").val()}function validatePayForm(){var v1=validatePayFormName(payFormItems.eq(0)),v2=validatePayFormTel(payFormItems.eq(1)),v3=validatePayFormVerifyCode(payFormItems.eq(2));return v1&&v2&&v3}function validatePayFormName($node){var value;return!!getFormValue($node)||($node.addClass("check-fail").find(".check-form").text("请输入名字"),!1)}function validatePayFormTel($node){var value=getFormValue($node),tips=$node.find(".check-form"),isTel;return value?!!/^1[0-9]{10}$/.test(value)||(tips.text("请输入正确的手机号码"),$node.addClass("check-fail"),!1):(tips.text("请输入手机号码"),$node.addClass("check-fail"),!1)}function validatePayFormVerifyCode($node){var value;return!!getFormValue($node)||($node.addClass("check-fail").find(".check-form").text("请输入验证码"),!1)}function getVerifyCode(){var disabled=$(this).hasClass("disabled"),mobileForm=payFormItems.eq(1),isTel=validatePayFormTel(mobileForm);if(!disabled&&isTel){var data={mobile:getFormValue(mobileForm),captcheCode:"",captchaKey:""};$.ajax({url:"/cloud/sms/sms/validCodeSend",type:"GET",dataType:"json",data:data,timeout:6e3,success:function(res){alert(1==res.code?"验证码发送成功":res.msgZ)},error:function(){}}),verifyCodeCountDown(59)}}function verifyCodeCountDown(second){getVerifyBtn.addClass("disabled"),getVerifyBtn.text("重新获取("+second+"s)");var timer=setInterval(function(){--second<0?(clearInterval(timer),getVerifyBtn.text("获取验证码"),getVerifyBtn.removeClass("disabled")):getVerifyBtn.text("重新获取("+second+"s)")},1e3)}function activiteCountDown(endTime){if(endTime)var timer=setInterval(function(){var nowTime=Math.floor((new Date).getTime()/1e3),delta=endTime-nowTime;if(delta<0)clearInterval(timer);else{var times,innerHTML=secondToHms(delta).split("").map(function(item){var isNumber;return/\d/.test(item)?'<span class="time">'+item+"</span>":"<span>"+item+"</span>"}).join("");countDoneNode.html(innerHTML)}},1e3)}invalidWatermark=wrap.find(".watermark-invalid"),unstartWatermark=wrap.find(".watermark-unstart"),initPage()})}(window,document,JSON,"undefined"==typeof $?void 0:$);